{"version":3,"sources":["../../../src/internal-plugins/component-layout-creator/gatsby-node.js"],"names":["globCB","require","Promise","_","chokidar","systemPath","glob","promisify","createPath","validatePath","exports","createPagesStatefully","options","doneCb","store","boundActionCreators","createLayout","deleteLayout","program","getState","layoutDirectory","posix","join","directory","exts","extensions","map","e","slice","files","forEach","_createLayout","file","watch","on","includes","path","push","layouts","filter","p","component","name","layout","f","filePath","relative","id"],"mappings":";;;;;;;;;;;;AAAA,IAAMA,SAASC,eAAf;AACA,IAAMC,UAAUD,mBAAhB;AACA,IAAME,IAAIF,iBAAV;AACA,IAAMG,WAAWH,mBAAjB;AACA,IAAMI,aAAaJ,eAAnB;;AAEA,IAAMK,OAAOJ,QAAQK,SAAR,CAAkBP,MAAlB,CAAb;;AAEA,IAAMQ,aAAaP,wBAAnB;AACA,IAAMQ,eAAeR,0BAArB;;AAEA;AACA;AACA;AACA;AACA;AACAS,QAAQC,qBAAR;AAAA,wEAAgC,wBAE9BC,OAF8B,EAG9BC,MAH8B;AAAA,QAC5BC,KAD4B,SAC5BA,KAD4B;AAAA,QACrBC,mBADqB,SACrBA,mBADqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAKtBC,wBALsB,GAKSD,mBALT,CAKtBC,YALsB,EAKRC,YALQ,GAKSF,mBALT,CAKRE,YALQ;AAMxBC,mBANwB,GAMdJ,MAAMK,QAAN,GAAiBD,OANH;AAOxBE,2BAPwB,GAONf,WAAWgB,KAAX,CAAiBC,IAAjB,CACtBJ,QAAQK,SADc,iBAPM;AAWxBC,gBAXwB,GAWjBN,QAAQO,UAAR,CAAmBC,GAAnB,CAAuB;AAAA,0BAAQC,EAAEC,KAAF,CAAQ,CAAR,CAAR;AAAA,aAAvB,EAA6CN,IAA7C,KAXiB;;AAa9B;;AAb8B;AAAA,mBAcZhB,KAAQc,eAAR,cAAgCI,IAAhC,OAdY;;AAAA;AAc1BK,iBAd0B;;AAe9BA,kBAAMC,OAAN,CAAc;AAAA,qBAAQC,cAAcC,IAAd,EAAoBZ,eAApB,EAAqCJ,YAArC,CAAR;AAAA,aAAd;;AAEA;AACAZ,qBACG6B,KADH,CACYb,eADZ,eACqCI,IADrC,QAEGU,EAFH,QAEa,gBAAQ;AACjB,kBAAI,CAAC/B,EAAEgC,QAAF,CAAWN,KAAX,EAAkBO,IAAlB,CAAL,EAA8B;AAC5BL,8BAAcK,IAAd,EAAoBhB,eAApB,EAAqCJ,YAArC;AACAa,sBAAMQ,IAAN,CAAWD,IAAX;AACD;AACF,aAPH,EAQGF,EARH,WAQgB,gBAAQ;AACpB;AACApB,oBACGK,QADH,GAEGmB,OAFH,CAEWC,MAFX,CAEkB;AAAA,uBAAKC,EAAEC,SAAF,KAAgBL,IAArB;AAAA,eAFlB,EAGGN,OAHH,CAGW,kBAAU;AACjBb,6BAAa,EAAEyB,MAAMC,OAAOD,IAAf,EAAb;AACAb,wBAAQA,MAAMU,MAAN,CAAa;AAAA,yBAAKK,MAAMF,IAAX;AAAA,iBAAb,CAAR;AACD,eANH;AAOD,aAjBH,EAkBGR,EAlBH,UAkBe;AAAA,qBAAMrB,QAAN;AAAA,aAlBf;;AAlB8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAhC;;AAAA;AAAA;AAAA;AAAA;AAsCA,IAAMkB,gBAAgB,SAAhBA,aAAgB,CAACc,QAAD,EAAWzB,eAAX,EAA4BJ,YAA5B,EAA6C;AACjE;AACA;AACA,MAAI,CAACP,aAAaJ,WAAWgB,KAAX,CAAiByB,QAAjB,CAA0B1B,eAA1B,EAA2CyB,QAA3C,CAAb,CAAL,EAAyE;AACvE;AACD;;AAED;AACA,MAAMF,SAAS;AACbI,QAAIvC,WAAWY,eAAX,EAA4ByB,QAA5B,CADS;AAEbJ,eAAWI;;AAGb;AALe,GAAf,CAMA7B,aAAa2B,MAAb;AACD,CAfD","file":"gatsby-node.js","sourcesContent":["const globCB = require(`glob`)\nconst Promise = require(`bluebird`)\nconst _ = require(`lodash`)\nconst chokidar = require(`chokidar`)\nconst systemPath = require(`path`)\n\nconst glob = Promise.promisify(globCB)\n\nconst createPath = require(`./create-path`)\nconst validatePath = require(`./validate-path`)\n\n// Path creator.\n// Auto-create layouts.\n// algorithm is glob /layouts directory for js/jsx/cjsx files *not*\n// underscored. Then create url w/ our path algorithm *unless* user\n// takes control of that page component in gatsby-node.\nexports.createPagesStatefully = async (\n  { store, boundActionCreators },\n  options,\n  doneCb\n) => {\n  const { createLayout, deleteLayout } = boundActionCreators\n  const program = store.getState().program\n  const layoutDirectory = systemPath.posix.join(\n    program.directory,\n    `/src/layouts`\n  )\n  const exts = program.extensions.map(e => `${e.slice(1)}`).join(`,`)\n\n  // Get initial list of files.\n  let files = await glob(`${layoutDirectory}/**/?(${exts})`)\n  files.forEach(file => _createLayout(file, layoutDirectory, createLayout))\n\n  // Listen for new component pages to be added or removed.\n  chokidar\n    .watch(`${layoutDirectory}/**/*.{${exts}}`)\n    .on(`add`, path => {\n      if (!_.includes(files, path)) {\n        _createLayout(path, layoutDirectory, createLayout)\n        files.push(path)\n      }\n    })\n    .on(`unlink`, path => {\n      // Delete the page for the now deleted component.\n      store\n        .getState()\n        .layouts.filter(p => p.component === path)\n        .forEach(layout => {\n          deleteLayout({ name: layout.name })\n          files = files.filter(f => f !== name)\n        })\n    })\n    .on(`ready`, () => doneCb())\n}\nconst _createLayout = (filePath, layoutDirectory, createLayout) => {\n  // Filter out special components that shouldn't be made into\n  // pages.\n  if (!validatePath(systemPath.posix.relative(layoutDirectory, filePath))) {\n    return\n  }\n\n  // Create page object\n  const layout = {\n    id: createPath(layoutDirectory, filePath),\n    component: filePath,\n  }\n\n  // Add page\n  createLayout(layout)\n}\n"]}