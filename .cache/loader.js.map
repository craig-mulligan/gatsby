{"version":3,"sources":["../../src/cache-dir/loader.js"],"names":["findPage","syncRequires","asyncRequires","pathScriptsCache","resourceStrCache","resourceCache","pages","pathArray","pathCount","resourcesArray","resourcesCount","preferDefault","m","default","prefetcher","inInitialRender","process","env","NODE_ENV","require","getNextQueuedResources","slice","createResourceDownload","fetchResource","resourceName","filter","r","onResourcedFinished","on","onPreLoadPageResources","e","onPostLoadPageResources","sortResourcesByCount","a","b","sortPagesByCount","cb","nextTick","resourceFunction","components","layouts","json","err","executeChunk","getResourceModule","module","mountOrder","queue","empty","addPagesArray","newPages","pathPrefix","__PREFIX_PATHS__","__PATH_PREFIX__","addDevRequires","devRequires","addProdRequires","prodRequires","dequeue","pop","enqueue","some","p","path","mountOrderBoost","has","unshift","sort","page","jsonName","indexOf","componentChunkName","onNewResourcesAdded","getResources","getPages","getPage","pathname","getResourcesForPathname","console","log","navigator","serviceWorker","controller","state","getRegistrations","then","registrations","registration","unregister","window","location","reload","pageResources","component","layout","layoutComponentChunkName","layoutJson","layoutJsonName","emit","done","c","j","l","lj","undefined","peek","length","exports"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;;;AACA,IAAIA,iBAAJ;;AAEA,IAAIC,eAAe,EAAnB;AACA,IAAIC,gBAAgB,EAApB;AACA,IAAIC,mBAAmB,EAAvB;AACA,IAAIC,mBAAmB,EAAvB;AACA,IAAIC,gBAAgB,EAApB;AACA,IAAIC,QAAQ,EAAZ;AACA;AACA;AACA;AACA,IAAIC,YAAY,EAAhB;AACA,IAAIC,YAAY,EAAhB;AACA,IAAIC,iBAAiB,EAArB;AACA,IAAIC,iBAAiB,EAArB;AACA,IAAMC,gBAAgB,SAAhBA,aAAgB;AAAA,SAAMC,KAAKA,EAAEC,OAAR,IAAoBD,CAAzB;AAAA,CAAtB;AACA,IAAIE,mBAAJ;AACA,IAAIC,kBAAkB,IAAtB;;AAEA;AACA,IAAIC,QAAQC,GAAR,CAAYC,QAAZ,iBAAJ,EAA2C;AACzCJ,eAAaK,wBAAwB;AACnCC,4BAAwB;AAAA,aAAMX,eAAeY,KAAf,CAAqB,CAAC,CAAtB,EAAyB,CAAzB,CAAN;AAAA,KADW;AAEnCC,4BAAwB,8CAAgB;AACtCC,oBAAcC,YAAd,EAA4B,YAAM;AAChCf,yBAAiBA,eAAegB,MAAf,CAAsB;AAAA,iBAAKC,MAAMF,YAAX;AAAA,SAAtB,CAAjB;AACAV,mBAAWa,mBAAX,CAA+BH,YAA/B;AACD,OAHD;AAID;AAPkC,GAAxB,CAAb;AASA,oBAAQI,EAAR,2BAAqC,aAAK;AACxCd,eAAWe,sBAAX,CAAkCC,CAAlC;AACD,GAFD;AAGA,oBAAQF,EAAR,4BAAsC,aAAK;AACzCd,eAAWiB,uBAAX,CAAmCD,CAAnC;AACD,GAFD;AAGD;;AAED,IAAME,uBAAuB,SAAvBA,oBAAuB,CAACC,CAAD,EAAIC,CAAJ,EAAU;AACrC,MAAIxB,eAAeuB,CAAf,IAAoBvB,eAAewB,CAAf,CAAxB,EAA2C;AACzC,WAAO,CAAP;AACD,GAFD,MAEO,IAAIxB,eAAeuB,CAAf,IAAoBvB,eAAewB,CAAf,CAAxB,EAA2C;AAChD,WAAO,CAAC,CAAR;AACD,GAFM,MAEA;AACL,WAAO,CAAP;AACD;AACF,CARD;;AAUA,IAAMC,mBAAmB,SAAnBA,gBAAmB,CAACF,CAAD,EAAIC,CAAJ,EAAU;AACjC,MAAI1B,UAAUyB,CAAV,IAAezB,UAAU0B,CAAV,CAAnB,EAAiC;AAC/B,WAAO,CAAP;AACD,GAFD,MAEO,IAAI1B,UAAUyB,CAAV,IAAezB,UAAU0B,CAAV,CAAnB,EAAiC;AACtC,WAAO,CAAC,CAAR;AACD,GAFM,MAEA;AACL,WAAO,CAAP;AACD;AACF,CARD;;AAUA,IAAMX,gBAAgB,SAAhBA,aAAgB,CAACC,YAAD,EAAiC;AAAA,MAAlBY,EAAkB,uEAAb,YAAM,CAAE,CAAK;;AACrD,MAAIhC,iBAAiBoB,YAAjB,CAAJ,EAAoC;AAClCR,YAAQqB,QAAR,CAAiB,YAAM;AACrBD,SAAG,IAAH,EAAShC,iBAAiBoB,YAAjB,CAAT;AACD,KAFD;AAGD,GAJD,MAIO;AACL;AACA,QAAMc,mBACJd,aAAaH,KAAb,CAAmB,CAAnB,EAAsB,CAAtB,oBACInB,cAAcqC,UAAd,CAAyBf,YAAzB,KAA0CtB,cAAcsC,OAAd,CAAsBhB,YAAtB,CAD9C,GAEItB,cAAcuC,IAAd,CAAmBjB,YAAnB,CAHN;;AAKA;AACAc,qBAAiB,UAACI,GAAD,EAAMC,YAAN,EAAuB;AACtCvC,uBAAiBoB,YAAjB,IAAiCmB,YAAjC;AACAP,SAAGM,GAAH,EAAQC,YAAR;AACD,KAHD;AAID;AACF,CAlBD;;AAoBA,IAAMC,oBAAoB,SAApBA,iBAAoB,CAACpB,YAAD,EAAeY,EAAf,EAAsB;AAC9C,MAAI/B,cAAcmB,YAAd,CAAJ,EAAiC;AAC/BR,YAAQqB,QAAR,CAAiB,YAAM;AACrBD,SAAG,IAAH,EAAS/B,cAAcmB,YAAd,CAAT;AACD,KAFD;AAGD,GAJD,MAIO;AACLD,kBAAcC,YAAd,EAA4B,UAACkB,GAAD,EAAMC,YAAN,EAAuB;AACjD,UAAID,GAAJ,EAAS;AACPN,WAAGM,GAAH;AACD,OAFD,MAEO;AACL,YAAMG,UAASlC,cAAcgC,cAAd,CAAf;AACAtC,sBAAcmB,YAAd,IAA8BqB,OAA9B;AACAT,WAAGM,GAAH,EAAQG,OAAR;AACD;AACF,KARD;AASD;AACF,CAhBD;;AAkBA,IAAIC,aAAa,CAAjB;AACA,IAAMC,QAAQ;AACZC,SAAO,iBAAM;AACXzC,gBAAY,EAAZ;AACAC,gBAAY,EAAZ;AACAE,qBAAiB,EAAjB;AACAD,qBAAiB,EAAjB;AACAH,YAAQ,EAAR;AACD,GAPW;AAQZ2C,iBAAe,iCAAY;AACzB3C,YAAQ4C,QAAR;AACA,QAAIC,eAAJ;AACA,QAAI,OAAOC,gBAAP,gBAAJ,EAA6C;AAC3CD,mBAAaE,eAAb;AACD;AACDrD,eAAW,wBAAkBkD,QAAlB,EAA4BC,UAA5B,CAAX;AACD,GAfW;AAgBZG,kBAAgB,qCAAe;AAC7BrD,mBAAesD,WAAf;AACD,GAlBW;AAmBZC,mBAAiB,uCAAgB;AAC/BtD,oBAAgBuD,YAAhB;AACD,GArBW;AAsBZC,WAAS;AAAA,WAAQnD,UAAUoD,GAAV,EAAR;AAAA,GAtBG;AAuBZC,WAAS,uBAAQ;AACf;AACA,QAAI,CAACtD,MAAMuD,IAAN,CAAW;AAAA,aAAKC,EAAEC,IAAF,KAAWA,IAAhB;AAAA,KAAX,CAAL,EAAuC;AACrC,aAAO,KAAP;AACD;;AAED,QAAMC,kBAAkB,IAAIlB,UAA5B;AACAA,kBAAc,CAAd;AACA;AACA;AACA;;AAEA;AACA,QAAI,CAACtC,UAAUuD,IAAV,CAAL,EAAsB;AACpBvD,gBAAUuD,IAAV,IAAkB,CAAlB;AACD,KAFD,MAEO;AACLvD,gBAAUuD,IAAV,KAAmB,CAAnB;AACD;;AAED;AACA,QAAI,CAAChB,MAAMkB,GAAN,CAAUF,IAAV,CAAL,EAAsB;AACpBxD,gBAAU2D,OAAV,CAAkBH,IAAlB;AACD;;AAED;AACAxD,cAAU4D,IAAV,CAAehC,gBAAf;;AAEA;AACA,QAAMiC,OAAOpE,SAAS+D,IAAT,CAAb;AACA,QAAIK,KAAKC,QAAT,EAAmB;AACjB,UAAI,CAAC3D,eAAe0D,KAAKC,QAApB,CAAL,EAAoC;AAClC3D,uBAAe0D,KAAKC,QAApB,IAAgC,IAAIL,eAApC;AACD,OAFD,MAEO;AACLtD,uBAAe0D,KAAKC,QAApB,KAAiC,IAAIL,eAArC;AACD;;AAED;AACA;AACA,UACEvD,eAAe6D,OAAf,CAAuBF,KAAKC,QAA5B,MAA0C,CAAC,CAA3C,IACA,CAACjE,iBAAiBgE,KAAKC,QAAtB,CAFH,EAGE;AACA5D,uBAAeyD,OAAf,CAAuBE,KAAKC,QAA5B;AACD;AACF;AACD,QAAID,KAAKG,kBAAT,EAA6B;AAC3B,UAAI,CAAC7D,eAAe0D,KAAKG,kBAApB,CAAL,EAA8C;AAC5C7D,uBAAe0D,KAAKG,kBAApB,IAA0C,IAAIP,eAA9C;AACD,OAFD,MAEO;AACLtD,uBAAe0D,KAAKG,kBAApB,KAA2C,IAAIP,eAA/C;AACD;;AAED;AACA;AACA,UACEvD,eAAe6D,OAAf,CAAuBF,KAAKG,kBAA5B,MAAoD,CAAC,CAArD,IACA,CAACnE,iBAAiBgE,KAAKC,QAAtB,CAFH,EAGE;AACA5D,uBAAeyD,OAAf,CAAuBE,KAAKG,kBAA5B;AACD;AACF;;AAED;AACA9D,mBAAe0D,IAAf,CAAoBnC,oBAApB;AACA,QAAIhB,QAAQC,GAAR,CAAYC,QAAZ,iBAAJ,EAA2C;AACzCJ,iBAAW0D,mBAAX;AACD;;AAED,WAAO,IAAP;AACD,GA5FW;AA6FZC,gBAAc,wBAAM;AAClB,WAAO;AACLhE,oCADK;AAELC;AAFK,KAAP;AAID,GAlGW;AAmGZgE,YAAU,oBAAM;AACd,WAAO;AACLnE,0BADK;AAELC;AAFK,KAAP;AAID,GAxGW;AAyGZmE,WAAS;AAAA,WAAY3E,SAAS4E,QAAT,CAAZ;AAAA,GAzGG;AA0GZX,OAAK;AAAA,WAAQ1D,UAAUsD,IAAV,CAAe;AAAA,aAAKC,MAAMC,IAAX;AAAA,KAAf,CAAR;AAAA,GA1GO;AA2GZc,2BAAyB,iCAACd,IAAD,EAAyB;AAAA,QAAlB3B,EAAkB,uEAAb,YAAM,CAAE,CAAK;;AAChD0C,YAAQC,GAAR,CAAY,OAAZ;AACA,QACEhE,mBACAiE,SADA,IAEAA,UAAUC,aAFV,IAGAD,UAAUC,aAAV,CAAwBC,UAHxB,IAIAF,UAAUC,aAAV,CAAwBC,UAAxB,CAAmCC,KAAnC,gBALF,EAME;AACA;AACA;AACA;AACA;AACA,UAAI,CAACnF,SAAS+D,IAAT,CAAL,EAAqB;AACnBiB,kBAAUC,aAAV,CACGG,gBADH,GAEGC,IAFH,CAEQ,UAASC,aAAT,EAAwB;AAAA;AAAA;AAAA;;AAAA;AAC5B,4DAAyBA,aAAzB,4GAAwC;AAAA,kBAA/BC,YAA+B;;AACtCA,2BAAaC,UAAb;AACD;AAH2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAI5BC,iBAAOC,QAAP,CAAgBC,MAAhB;AACD,SAPH;AAQD;AACF;AACD5E,sBAAkB,KAAlB;AACA;AACA;AACA,QAAIC,QAAQC,GAAR,CAAYC,QAAZ,iBAAJ,EAA2C;AACzC,UAAMkD,OAAOpE,SAAS+D,IAAT,CAAb;AACA,UAAI,CAACK,IAAL,EAAW;AACX,UAAMwB,gBAAgB;AACpBC,mBAAW5F,aAAasC,UAAb,CAAwB6B,KAAKG,kBAA7B,CADS;AAEpB9B,cAAMxC,aAAawC,IAAb,CAAkB2B,KAAKC,QAAvB,CAFc;AAGpByB,gBAAQ7F,aAAauC,OAAb,CAAqB4B,KAAK2B,wBAA1B,CAHY;AAIpBC,oBAAY/F,aAAawC,IAAb,CAAkB2B,KAAK6B,cAAvB;AAJQ,OAAtB;AAMA7D,SAAGwD,aAAH;AACA,aAAOA,aAAP;AACA;AACD,KAZD,MAYO;AACL,UAAMxB,QAAOpE,SAAS+D,IAAT,CAAb;;AAEA,UAAI,CAACK,KAAL,EAAW;AACTU,gBAAQC,GAAR,gCAAwChB,IAAxC;AACA;AACD;;AAED;AACA;AACAA,aAAOK,MAAKL,IAAZ;;AAEA;AACA,UAAI5D,iBAAiB4D,IAAjB,CAAJ,EAA4B;AAC1B/C,gBAAQqB,QAAR,CAAiB,YAAM;AACrBD,aAAGjC,iBAAiB4D,IAAjB,CAAH;AACA,4BAAQmC,IAAR,4BAAwC;AACtC9B,uBADsC;AAEtCwB,2BAAezF,iBAAiB4D,IAAjB;AAFuB,WAAxC;AAID,SAND;AAOA,eAAO5D,iBAAiB4D,IAAjB,CAAP;AACD;;AAED,wBAAQmC,IAAR,2BAAuC,EAAEnC,UAAF,EAAvC;AACA;AACA,UAAI8B,kBAAJ;AACA,UAAIpD,aAAJ;AACA,UAAIqD,eAAJ;AACA,UAAIE,mBAAJ;AACA;AACA;AACA;AACA,UAAMG,OAAO,SAAPA,IAAO,GAAM;AACjB,YAAIN,aAAapD,IAAb,IAAqBqD,MAArB,IAA+BE,UAAnC,EAA+C;AAC7C7F,2BAAiB4D,IAAjB,IAAyB,EAAE8B,oBAAF,EAAapD,UAAb,EAAmBqD,cAAnB,EAAzB;AACA,cAAMF,iBAAgB,EAAEC,oBAAF,EAAapD,UAAb,EAAmBqD,cAAnB,EAAtB;AACA1D,aAAGwD,cAAH;AACA,4BAAQM,IAAR,4BAAwC;AACtC9B,uBADsC;AAEtCwB;AAFsC,WAAxC;AAID;AACF,OAVD;AAWAhD,wBAAkBwB,MAAKG,kBAAvB,EAA2C,UAAC7B,GAAD,EAAM0D,CAAN,EAAY;AACrD,YAAI1D,GAAJ,EAAS;AACPoC,kBAAQC,GAAR,gCAAyCX,MAAKL,IAA9C;AACD;AACD8B,oBAAYO,CAAZ;AACAD;AACD,OAND;AAOAvD,wBAAkBwB,MAAKC,QAAvB,EAAiC,UAAC3B,GAAD,EAAM2D,CAAN,EAAY;AAC3C,YAAI3D,GAAJ,EAAS;AACPoC,kBAAQC,GAAR,2BAAoCX,MAAKL,IAAzC;AACD;AACDtB,eAAO4D,CAAP;AACAF;AACD,OAND;;AAQAvD,wBAAkBwB,MAAK2B,wBAAvB,EAAiD,UAACrD,GAAD,EAAM4D,CAAN,EAAY;AAC3D,YAAI5D,GAAJ,EAAS;AACPoC,kBAAQC,GAAR,6BAAsCX,MAAKL,IAA3C;AACD;AACD+B,iBAASQ,CAAT;AACAH;AACD,OAND;;AAQAvD,wBAAkBwB,MAAK6B,cAAvB,EAAuC,UAACvD,GAAD,EAAM6D,EAAN,EAAa;AAClD,YAAI7D,GAAJ,EAAS;AACPoC,kBAAQC,GAAR,kCAA2CX,MAAKL,IAAhD;AACD;AACDiC,qBAAaO,EAAb;AACAJ;AACD,OAND;;AAQA,aAAOK,SAAP;AACD;AACF,GA/NW;AAgOZC,QAAM;AAAA,WAAQlG,UAAUc,KAAV,CAAgB,CAAC,CAAjB,EAAoB,CAApB,CAAR;AAAA,GAhOM;AAiOZqF,UAAQ;AAAA,WAAMnG,UAAUmG,MAAhB;AAAA,GAjOI;AAkOZpC,WAAS;AAAA,WAAQ/D,UAAUmG,MAAV,GAAmBnG,UAAU+D,OAAV,CAAkBP,IAAlB,CAAnB,GAA6C,CAArD;AAAA;AAlOG,CAAd;;AAqOAlB,OAAO8D,OAAP,GAAiB5D,KAAjB","file":"loader.js","sourcesContent":["import React, { createElement } from \"react\"\nimport pageFinderFactory from \"./find-page\"\nimport emitter from \"./emitter\"\nlet findPage\n\nlet syncRequires = {}\nlet asyncRequires = {}\nlet pathScriptsCache = {}\nlet resourceStrCache = {}\nlet resourceCache = {}\nlet pages = []\n// Note we're not actively using the path data atm. There\n// could be future optimizations however around trying to ensure\n// we load all resources for likely-to-be-visited paths.\nlet pathArray = []\nlet pathCount = {}\nlet resourcesArray = []\nlet resourcesCount = {}\nconst preferDefault = m => (m && m.default) || m\nlet prefetcher\nlet inInitialRender = true\n\n// Prefetcher logic\nif (process.env.NODE_ENV === `production`) {\n  prefetcher = require(`./prefetcher`)({\n    getNextQueuedResources: () => resourcesArray.slice(-1)[0],\n    createResourceDownload: resourceName => {\n      fetchResource(resourceName, () => {\n        resourcesArray = resourcesArray.filter(r => r !== resourceName)\n        prefetcher.onResourcedFinished(resourceName)\n      })\n    },\n  })\n  emitter.on(`onPreLoadPageResources`, e => {\n    prefetcher.onPreLoadPageResources(e)\n  })\n  emitter.on(`onPostLoadPageResources`, e => {\n    prefetcher.onPostLoadPageResources(e)\n  })\n}\n\nconst sortResourcesByCount = (a, b) => {\n  if (resourcesCount[a] > resourcesCount[b]) {\n    return 1\n  } else if (resourcesCount[a] < resourcesCount[b]) {\n    return -1\n  } else {\n    return 0\n  }\n}\n\nconst sortPagesByCount = (a, b) => {\n  if (pathCount[a] > pathCount[b]) {\n    return 1\n  } else if (pathCount[a] < pathCount[b]) {\n    return -1\n  } else {\n    return 0\n  }\n}\n\nconst fetchResource = (resourceName, cb = () => {}) => {\n  if (resourceStrCache[resourceName]) {\n    process.nextTick(() => {\n      cb(null, resourceStrCache[resourceName])\n    })\n  } else {\n    // Find resource\n    const resourceFunction =\n      resourceName.slice(0, 9) === `component`\n        ? asyncRequires.components[resourceName] || asyncRequires.layouts[resourceName]\n        : asyncRequires.json[resourceName]\n\n    // Download the resource\n    resourceFunction((err, executeChunk) => {\n      resourceStrCache[resourceName] = executeChunk\n      cb(err, executeChunk)\n    })\n  }\n}\n\nconst getResourceModule = (resourceName, cb) => {\n  if (resourceCache[resourceName]) {\n    process.nextTick(() => {\n      cb(null, resourceCache[resourceName])\n    })\n  } else {\n    fetchResource(resourceName, (err, executeChunk) => {\n      if (err) {\n        cb(err)\n      } else {\n        const module = preferDefault(executeChunk())\n        resourceCache[resourceName] = module\n        cb(err, module)\n      }\n    })\n  }\n}\n\nlet mountOrder = 1\nconst queue = {\n  empty: () => {\n    pathArray = []\n    pathCount = {}\n    resourcesCount = {}\n    resourcesArray = []\n    pages = []\n  },\n  addPagesArray: newPages => {\n    pages = newPages\n    let pathPrefix = ``\n    if (typeof __PREFIX_PATHS__ !== `undefined`) {\n      pathPrefix = __PATH_PREFIX__\n    }\n    findPage = pageFinderFactory(newPages, pathPrefix)\n  },\n  addDevRequires: devRequires => {\n    syncRequires = devRequires\n  },\n  addProdRequires: prodRequires => {\n    asyncRequires = prodRequires\n  },\n  dequeue: path => pathArray.pop(),\n  enqueue: path => {\n    // Check page exists.\n    if (!pages.some(p => p.path === path)) {\n      return false\n    }\n\n    const mountOrderBoost = 1 / mountOrder\n    mountOrder += 1\n    // console.log(\n    // `enqueue \"${path}\", mountOrder: \"${mountOrder}, mountOrderBoost: ${mountOrderBoost}`\n    // )\n\n    // Add to path counts.\n    if (!pathCount[path]) {\n      pathCount[path] = 1\n    } else {\n      pathCount[path] += 1\n    }\n\n    // Add path to queue.\n    if (!queue.has(path)) {\n      pathArray.unshift(path)\n    }\n\n    // Sort pages by pathCount\n    pathArray.sort(sortPagesByCount)\n\n    // Add resources to queue.\n    const page = findPage(path)\n    if (page.jsonName) {\n      if (!resourcesCount[page.jsonName]) {\n        resourcesCount[page.jsonName] = 1 + mountOrderBoost\n      } else {\n        resourcesCount[page.jsonName] += 1 + mountOrderBoost\n      }\n\n      // Before adding, checking that the JSON resource isn't either\n      // already queued or been downloading.\n      if (\n        resourcesArray.indexOf(page.jsonName) === -1 &&\n        !resourceStrCache[page.jsonName]\n      ) {\n        resourcesArray.unshift(page.jsonName)\n      }\n    }\n    if (page.componentChunkName) {\n      if (!resourcesCount[page.componentChunkName]) {\n        resourcesCount[page.componentChunkName] = 1 + mountOrderBoost\n      } else {\n        resourcesCount[page.componentChunkName] += 1 + mountOrderBoost\n      }\n\n      // Before adding, checking that the component resource isn't either\n      // already queued or been downloading.\n      if (\n        resourcesArray.indexOf(page.componentChunkName) === -1 &&\n        !resourceStrCache[page.jsonName]\n      ) {\n        resourcesArray.unshift(page.componentChunkName)\n      }\n    }\n\n    // Sort resources by resourcesCount.\n    resourcesArray.sort(sortResourcesByCount)\n    if (process.env.NODE_ENV === `production`) {\n      prefetcher.onNewResourcesAdded()\n    }\n\n    return true\n  },\n  getResources: () => {\n    return {\n      resourcesArray,\n      resourcesCount,\n    }\n  },\n  getPages: () => {\n    return {\n      pathArray,\n      pathCount,\n    }\n  },\n  getPage: pathname => findPage(pathname),\n  has: path => pathArray.some(p => p === path),\n  getResourcesForPathname: (path, cb = () => {}) => {\n    console.log('hiiii')\n    if (\n      inInitialRender &&\n      navigator &&\n      navigator.serviceWorker &&\n      navigator.serviceWorker.controller &&\n      navigator.serviceWorker.controller.state === `activated`\n    ) {\n      // If we're loading from a service worker (it's already activated on\n      // this initial render) and we can't find a page, there's a good chance\n      // we're on a new page that this (now old) service worker doesn't know\n      // about so we'll unregister it and reload.\n      if (!findPage(path)) {\n        navigator.serviceWorker\n          .getRegistrations()\n          .then(function(registrations) {\n            for (let registration of registrations) {\n              registration.unregister()\n            }\n            window.location.reload()\n          })\n      }\n    }\n    inInitialRender = false\n    // In development we know the code is loaded already\n    // so we just return with it immediately.\n    if (process.env.NODE_ENV !== `production`) {\n      const page = findPage(path)\n      if (!page) return\n      const pageResources = {\n        component: syncRequires.components[page.componentChunkName],\n        json: syncRequires.json[page.jsonName],\n        layout: syncRequires.layouts[page.layoutComponentChunkName],\n        layoutJson: syncRequires.json[page.layoutJsonName]\n      }\n      cb(pageResources)\n      return pageResources\n      // Production code path\n    } else {\n      const page = findPage(path)\n\n      if (!page) {\n        console.log(`A page wasn't found for \"${path}\"`)\n        return\n      }\n\n      // Use the path from the page so the pathScriptsCache uses\n      // the normalized path.\n      path = page.path\n\n      // Check if it's in the cache already.\n      if (pathScriptsCache[path]) {\n        process.nextTick(() => {\n          cb(pathScriptsCache[path])\n          emitter.emit(`onPostLoadPageResources`, {\n            page,\n            pageResources: pathScriptsCache[path],\n          })\n        })\n        return pathScriptsCache[path]\n      }\n\n      emitter.emit(`onPreLoadPageResources`, { path })\n      // Nope, we need to load resource(s)\n      let component\n      let json\n      let layout\n      let layoutJson\n      // Load the component/json/layout and parallel and call this\n      // function when they're done loading. When both are loaded,\n      // we move on.\n      const done = () => {\n        if (component && json && layout && layoutJson) {\n          pathScriptsCache[path] = { component, json, layout }\n          const pageResources = { component, json, layout }\n          cb(pageResources)\n          emitter.emit(`onPostLoadPageResources`, {\n            page,\n            pageResources,\n          })\n        }\n      }\n      getResourceModule(page.componentChunkName, (err, c) => {\n        if (err) {\n          console.log(`Loading the component for ${page.path} failed`)\n        }\n        component = c\n        done()\n      })\n      getResourceModule(page.jsonName, (err, j) => {\n        if (err) {\n          console.log(`Loading the JSON for ${page.path} failed`)\n        }\n        json = j\n        done()\n      })\n\n      getResourceModule(page.layoutComponentChunkName, (err, l) => {\n        if (err) {\n          console.log(`Loading the Layout for ${page.path} failed`)\n        }\n        layout = l\n        done()\n      })\n\n      getResourceModule(page.layoutJsonName, (err, lj) => {\n        if (err) {\n          console.log(`Loading the Layout JSON for ${page.path} failed`)\n        }\n        layoutJson = lj\n        done()\n      })\n\n      return undefined\n    }\n  },\n  peek: path => pathArray.slice(-1)[0],\n  length: () => pathArray.length,\n  indexOf: path => pathArray.length - pathArray.indexOf(path) - 1,\n}\n\nmodule.exports = queue\n"]}